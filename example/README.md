# Example application showing polyphony

## Notes in advance
Derived from the "faust_mqtt_tcp6_nb_v2 polyphony OK" version in the repo.
Note: the first working version contains WIFI and MQTT functionality for enabling remote control of Dsp parameters. This code will be progressively removed to get a basic example for demonstrating polyphony.

Work ongoing to:
- clean up the code and folder
- describe key learnings for getting a working example


## How to use example

### Software environment

- ESP-IDF under Windows 10 (for compilation of the C++ code)

- A Faust local install was used for generation of the DspFaust.cpp / .h files.  This environment is not required for running the example as these files are included in the example.   

### Hardware Required

This example has been developed on a ....... ESP32 board. No other connections than a serial connection for uploading the firmware and reading out monitor information are required. The audio is played over the headphone connection of the board.

### Creation of Faust DSP code

Refer to Faust docs for a description of how to dow this.
The example uses the Faust **sawtooth_synt.dsp** engine. This code was compiled in a local install of the Faust software, using the faust2api script. The command used for compilation was:  faust2api -ESP32 -nvoices 12 sawtooth_synth.dsp.  The output contains a DspFaust.cpp / .h set of files and a README.md with a description of the specific API for this engine.  
The example folder contains a number of folders with these files for other sound engines. To get firmware based on a different sound engine, just copy the files into the main folder of the project and build/flash the firmware as described below. 
NOTE: with the current project / compiler settings 1 change has to be made in the DspFaust files that are generated by the Faust compiler. A line with **throw bad_alloc()** has to be commented out of the code. The issue can possibly be solved with tuning the compiler settings.

### Including the jdksmidi lib

The code depends on using the jdksmidi lib.  The presence of the #include jdksmidi line(s) in the code alone **is not sufficient** to get successful compilation. A quite "dirty" workaround has been implemented in this example. For simple use of the example, the user does not need to pay attention to this. 

1. A minimal set of files from the lib have been added to the project in the main folder and in a jdksmidi folder within the main folder.
2. The files have been taken from a hack by ......  (link) of the orginal library by ..... (link). The files have been renamed (leading "jdksmidi_" removed).





### Configure the project
(partially dummy content, to be edited)

- Installation of the ESP-IDF environment is considered as out of scope for this description. Please consult relevant sources of information.
- One of the learnings during development of this example is that the ESP-IDF project and compiler settings are as important as the C++ code itself. Different settings may lead to a non-working example.  
- The settings stored with this example (in CMAKE and ....sdk files)  lead to a working example for the included engines. The settings may not be optimal and may not work for other DSP engines. For example: the WaveSynth_FX.dsp engine does not work with the current settings, probably because of the heavy computational load for it.
- A description of the why's for changed settings will be described separately.


- Copy the example folder to your system
- Open the ESP-IDF environment. (e.g. ESP-IDF 4.2 Powershell in Windows Terminal).
- Move to the example directory (this is the parent directory of the main folder).
- .... set the environment for ESP32  (1 time requirement)

* Open the project configuration menu (`idf.py menuconfig`)
* Configure Wi-Fi or Ethernet under "Example Connection Configuration" menu. See "Establishing Wi-Fi or Ethernet Connection" section in [examples/protocols/README.md](../../README.md) for more details.
* When using Make build system, set `Default serial port` under `Serial flasher config`.

### Build and Flash
(dummy content, to be edited)


- Remove existing build informatin with **idf.py fullclean** (required e.g. after copying new DspFaust files to the main folder) 
- Build the project: **idf.py --no-ccache build** or **idf.py --no-ccache build > buildlog.txt** if you want to keep the compiler output for debugging purposes
- Flash the firmware and  

Build the project and flash it to the board, then run monitor tool to view serial output:

```
idf.py -p PORT flash monitor
```

(To exit the serial monitor, type ``Ctrl-]``.)

See the Getting Started Guide for full steps to configure and use ESP-IDF to build projects.

## Example Output
(dummy content, to be edited)
```
I (3714) event: sta ip: 192.168.0.139, mask: 255.255.255.0, gw: 192.168.0.2
I (3714) system_api: Base MAC address is not set, read default base MAC address from BLK0 of EFUSE
I (3964) MQTT_CLIENT: Sending MQTT CONNECT message, type: 1, id: 0000
I (4164) MQTT_EXAMPLE: MQTT_EVENT_CONNECTED
I (4174) MQTT_EXAMPLE: sent publish successful, msg_id=41464
I (4174) MQTT_EXAMPLE: sent subscribe successful, msg_id=17886
I (4174) MQTT_EXAMPLE: sent subscribe successful, msg_id=42970
I (4184) MQTT_EXAMPLE: sent unsubscribe successful, msg_id=50241
I (4314) MQTT_EXAMPLE: MQTT_EVENT_PUBLISHED, msg_id=41464
I (4484) MQTT_EXAMPLE: MQTT_EVENT_SUBSCRIBED, msg_id=17886
I (4484) MQTT_EXAMPLE: sent publish successful, msg_id=0
I (4684) MQTT_EXAMPLE: MQTT_EVENT_SUBSCRIBED, msg_id=42970
I (4684) MQTT_EXAMPLE: sent publish successful, msg_id=0
I (4884) MQTT_CLIENT: deliver_publish, message_length_read=19, message_length=19
I (4884) MQTT_EXAMPLE: MQTT_EVENT_DATA
TOPIC=/topic/qos0
DATA=data
I (5194) MQTT_CLIENT: deliver_publish, message_length_read=19, message_length=19
I (5194) MQTT_EXAMPLE: MQTT_EVENT_DATA
TOPIC=/topic/qos0
DATA=data
```
## Further notes

The program uses the initial settings for the DSP parameters and can be changed by the user in his application. See the API description for a specific sound engine in the README.md generated by the Faust compiler. 

