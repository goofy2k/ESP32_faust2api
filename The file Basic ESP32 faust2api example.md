# DSP On the ESP32 with Faust  
## faust2api script for ESP32 under ESP-IDF (intermediate results)  

This document is intended for consolidation of the intermediate status on using the faust2api script for ESP32.
A working basic example app is available (example_faust_mqtt_tcp4_v3). The example:  
- has been created for compilation under ESP-IDF
- is based on the Faust elecGuitarMidi.dsp sound engine
- has been tested on a TTGO TAudio board 

To get the example working we had to:

- tune ESP-IDF project settings using idf.py menuconfig
- use specific commands for compilation
- modify the DspFaust.cpp file generated by compilation of the elecGuitarMidi.dsp engine with the faust2api script

This document contains a:
1. general description of the example
2. walkthrough on how to use this example under ESP-IDF  
3. walkthrough for creation of a project based on this example with a different Faust sound engine 
4. description of the ESP-IDF project settings and their rationale
 
In the future the faust2api script my have to be adapted for use with an ESP32. As the current status is premature, adaptation of the faust2api script is not yet part of the work until now.
 
The adaptations in the  DspFaust.cpp file may be specific for the used sound engine and usage environment (mainly MIDI I/O for elecGuitarMIDI)
 
Any changes implemented during write up of this consolidation are done in ESP-IDF project faust_mqtt_tcp5_v1

## 1. General description of the example

The example uses the the output generated by the faust2api script for the chosen sound engine (elecGuitarMIDI). The WM8978 audio codec driver files are used unmodified. The DspFaust.cpp file has been modified to get things working. This specifically concerns (parts of) the MIDI configuration. Some of these these modifications may have to be implemented later in the faust2api script for ESP32.

The example contains a main C++ app where the WM8978 audio codec and sound engine are initiated and started in the same way as described in the tutorial on [DSP on the ESP32 With Faust](https://faustdoc.grame.fr/tutorials/esp32/). In addition the app provides connectivity to a WIFI network and an MQTT broker. This is useful for testing the Faust API, but can also be used for future aplications. MQTT can be used to send Faust API commands to the board and receive UI information. Sending and receiving MQTT messages is operational. A very premature version of an API command dispatcher is present. After startup, the app plays a tune (routine: play_rtttl(song, DSP) which uses the DSP->setParamValue API command).  

 
## 2. Walkthrough on how to use the example_faust_mqtt_tcp4_v3 under ESP-IDF  

The example must be compiled in the ESP-IDF environment as a C++ app. To this end the project folder contains a folder main with a main.cpp file (only for this aspect see the praragraph Starting a New ESP32 Project in the tutorial on [DSP on the ESP32 With Faust](https://faustdoc.grame.fr/tutorials/esp32/). 


## 3. Walkthrough for creation of a project based on this example with a different Faust sound engine 
(test first with elecGuitarMidi.dsp, includes description of the faust2api options,  changing the DspFaust,  specifically:  MidiMeta::analyse(mono_dsp, midi_sync, nvoices);)
(describe folder project structure, location of sound engine files and MakeLists.txt etc.)
(Then test with different sound engine, e.g. simpleSynth_Analog.dsp or WaveSynth_FX.dsp)

## 4. Description of the ESP-IDF project settings and their rationale
  
ESP-IDF project settings can be modified with the idf.py menuconfig command. The settings are saved in the **sdkconfig** file in the root folder of the project. Here we discuss the settings that were important to get the example running. The safest way to start your own project is to copy the project structure, including the contents of the sdkconfig file.

